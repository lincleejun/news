name: News Agent

on:
  schedule:
    - cron: '0 16 * * *'  # 08:00 US Pacific (UTC-8)
    - cron: '0 23 * * *'  # 15:00 US Pacific (UTC-8)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync

      - name: Restore SQLite database
        uses: actions/cache@v4
        with:
          path: data/news.db
          key: news-db-${{ github.run_id }}
          restore-keys: |
            news-db-

      - name: Create config from secrets
        run: |
          cat > config.yaml << 'HEREDOC'
          sources:
            hackernews:
              enabled: true
              max_items: 30
            reddit:
              enabled: ${{ secrets.REDDIT_CLIENT_ID != '' }}
              subreddits: ["technology", "programming", "MachineLearning"]
              client_id: "${{ secrets.REDDIT_CLIENT_ID }}"
              client_secret: "${{ secrets.REDDIT_CLIENT_SECRET }}"
            v2ex:
              enabled: true
              nodes: ["programmer", "create", "apple"]
            x_com:
              enabled: false
            github:
              enabled: true
            wired:
              enabled: true
            arxiv_papers:
              enabled: true
              max_papers: 10
            ai_blogs:
              enabled: true
              feeds:
                - "https://www.anthropic.com/rss.xml"
                - "https://openai.com/news/rss.xml"
                - "https://blog.google/technology/google-deepmind/rss/"
                - "https://huggingface.co/blog/feed.xml"
                - "https://stability.ai/blog?format=rss"
                - "https://txt.cohere.ai/rss/"
                - "https://mistral.ai/feed/rss.xml"
            rss:
              enabled: true
              feeds:
                - "https://simonwillison.net/atom/everything/"
                - "https://www.jeffgeerling.com/blog.xml"
                - "https://krebsonsecurity.com/feed/"
                - "https://daringfireball.net/feeds/main"
                - "https://pluralistic.net/feed/"
                - "https://lcamtuf.substack.com/feed"
                - "https://mitchellh.com/feed.xml"
                - "https://dynomight.net/feed.xml"
                - "https://xeiaso.net/blog.rss"
                - "https://devblogs.microsoft.com/oldnewthing/feed"
                - "https://www.righto.com/feeds/posts/default"
                - "https://lucumr.pocoo.org/feed.atom"
                - "https://garymarcus.substack.com/feed"
                - "https://rachelbythebay.com/w/atom.xml"
                - "https://overreacted.io/rss.xml"
                - "https://matklad.github.io/feed.xml"
                - "https://eli.thegreenplace.net/feeds/all.atom.xml"
                - "https://fabiensanglard.net/rss.xml"
                - "https://www.troyhunt.com/rss/"
                - "https://blog.miguelgrinberg.com/feed"
                - "https://computer.rip/rss.xml"
                - "https://www.tedunangst.com/flak/rss"
                - "https://feeds.arstechnica.com/arstechnica/index"
                - "https://www.theverge.com/rss/index.xml"
                - "https://petapixel.com/feed/"
          llm:
            model: "openai/gpt-4o-mini"
            api_base: "https://models.inference.ai.azure.com"
            recommend_threshold: 7.0
          notifier:
            email:
              enabled: ${{ secrets.EMAIL_USERNAME != '' }}
              smtp_host: "${{ secrets.SMTP_HOST }}"
              smtp_port: 587
              username: "${{ secrets.EMAIL_USERNAME }}"
              password: "${{ secrets.EMAIL_PASSWORD }}"
              to: "${{ secrets.EMAIL_TO }}"
            telegram:
              enabled: ${{ secrets.TELEGRAM_BOT_TOKEN != '' }}
              bot_token: "${{ secrets.TELEGRAM_BOT_TOKEN }}"
              chat_id: "${{ secrets.TELEGRAM_CHAT_ID }}"
            file:
              enabled: true
              output_dir: "output"
          interests:
            - "AI/机器学习"
            - "编程/开发工具"
            - "硬件/数码"
            - "科技新闻"
            - "徒步/户外"
            - "摄影"
            - "国家地理/孤独星球"
          HEREDOC

      - name: Create data directory
        run: mkdir -p data

      - name: Run News Agent
        env:
          OPENAI_API_KEY: ${{ secrets.GITHUB_TOKEN }}
        run: uv run news-agent

      - name: Upload news output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: news-output-${{ github.run_id }}
          path: output/
          retention-days: 30
          if-no-files-found: ignore

      - name: Save SQLite database
        if: always()
        uses: actions/cache/save@v4
        with:
          path: data/news.db
          key: news-db-${{ github.run_id }}
